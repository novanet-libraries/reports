<div class="container-fluid">
  <div class="row">
    <div class="col-7">
      <div class="form-group">
        <label for="sublibrary">Sublibrary</label>
        <select id="sublibrary" class="form-control" data-placeholder="Sublibrary" multiple><option></option></select>
      </div>
      <div id="date-group-element" class="form-group">
        <label for="period">Period</label>
        <input id="startdate" type="hidden">
        <input id="enddate" type="hidden">
        <div id="period">
          <span class="glyphicon glyphicon-calendar" aria-hidden="true"></span>
          <span class="date-display"></span>
          <span class="glyphicon glyphicon-menu-down" aria-hidden="true"></span>
        </div>
      </div>
    </div>
    <div class="col-5">
      <div id="cnranges">
        <div class="form-row">
          <label for="cnrange-1">Call Number Range</label>
          <input type="text" class="form-control" id="cnrange-1" pattern="([A-Z]{1,3}\s?(?:[1-9][0-9\.]{0,8})?)(?:\s{0,3}-\s{0,3}([A-Z]{0,3}\s?(?:[1-9][0-9\.]{0,8})?))?" />
          <a href="#" class="delete btn btn-default" role="button">
            <span class="glyphicon glyphicon-remove" aria-hidden="true"></span>
            <span class="sr-only">Remove this row</span>
          </a>
        </div>
        <button type="button" class="add btn btn-default">
          <span class="glyphicon glyphicon-plus" aria-hidden="true"></span>
          <span class="sr-only">Add a row</span>
        </button>
      </div>
    </div>
  </div>
  <div class="row">
    <button class="btn btn-primary" id="submit">Go</button>
  </div>
</div>
<script>
$(document).ready(function() {
  var report = novanet.allreports['circ-by-callnumber'];

  var $sublibSelect = $('#sublibrary'),
      prohibited    = /^(.+NET|NSHA|NOVA|WWW)$/,
      $start        = $("#startdate"),
      $end          = $("#enddate"),
      $cnranges     = $("#cnranges");

  //add options to $sublibSelect
  $.each(Object.keys(novanet.data.sublibraries).sort(), function(idx, code){
    var text = novanet.data.sublibraries[code],
        $opt = $("<option>").attr("value", code).html(text + "(" + code + ")");
    
    if (code.match(prohibited)){
      $opt.prop("disabled", true);
    }
    $sublibSelect.append($opt);
  });

  //make it nice:
  $sublibSelect.chosen({
    no_results_text: "No matching sublibrary",
    search_contains: true,
    label_with_value_only: true,
    width: '25em'
  });

  //set up daterangepicker
  $start.val(moment().subtract(350, 'days').startOf('year').format('YYYY-MM-DD'));
  $end.val(moment($start.val()).add(1,'year').format('YYYY-MM-DD'));
  $('#period').daterangepicker({
    parentEl: '#date-group-element',
    startDate: moment($start.val()),
    endDate: moment($end.val()),
    minDate: moment().subtract(6, 'years'),
    maxDate: moment(),
    maxSpan: {'years': 1},
    ranges: {
      'Last 30 Days': [moment().subtract(29,'days'), moment()],
      'Last Month': [moment().subtract(1,'month').startOf('month'), moment().subtract(1,'month').endOf('month')],
      'Last Academic Year': novanet.fn.prevYearStartingAt(8),
      'Last Calendar Year': novanet.fn.prevYearStartingAt(0)
    }
  },function(s,e){
    $('#period .date-display').html(s.format('MMMM D, YYYY') + ' - ' + e.format('MMMM D, YYYY'));
    $start.val(s.format('YYYY-MM-DD'));
    $end.val(e.format('YYYY-MM-DD'));
  });

  //set up the callnumber range input
  $cnranges.on("click", ".delete", function(evt){
    evt.preventDefault();
    $(this).parents(".form-row").remove();
  }).on("click", ".add", function(evt){
    evt.preventDefault();
    var $last  = $cnranges.find(".form-row").last()
        $clone = $last.clone(),
        $input = $clone.find("input"),
        id     = $input.attr("id"),
        num    = parseInt(name.substr(name.indexOf('-')+1),10);
    $input.val("").attr("id", "cnrange-" + (++num));
    $clone.find("label").attr("for", "cnrange-" + num);
    $last.after($clone);
  });

  //submitting the form loads the results.
  $("#submit").on('click', function(evt){
    var sublibrary = $sublibSelect.val(),
        startdate = $start.val(),
        enddate  = $end.val(),
        cnranges = $cnranges.find("input").map(function(){ return $(this).val() || null; }).get();
    
    if (!startdate || !enddate || !sublibrary || sublibrary === [] || !cnranges || cnranges === []){
      //more fully validate start date
      return false;
    }

    var data = {
      "sublibrary[]": sublibrary,
      "start-date": startdate,
      "end-date": enddate,
      "range[]": cnranges
    };

    novanet.fn.loadResults(report, data);
    novanet.fn.pushState(report, data);
  });
});

</script>

