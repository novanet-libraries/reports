<div class="container-fluid">
  <div class="row">
    <div class="col-md-4 col-sm-6">
      <div class="form-horizontal">
        <div class="form-group">
          <label for="sublibrary" class="col-sm-2">Sublibrary</label>
          <div class="col-sm-10"
            <select id="sublibrary" class="form-control" data-placeholder="Sublibrary" multiple><option></option></select>
          </div>
        </div>
        <div id="date-group-element" class="form-group">
          <label for="period" class="col-sm-2">Period</label>
          <input id="startdate" type="hidden">
          <input id="enddate" type="hidden">
          <span id="period" class="col-sm-10" style="padding: 0.8em; border:#ccc 1px solid; border-radius:0.3em;">
            <span class="glyphicon glyphicon-calendar" aria-hidden="true"></span>
            <span class="date-display"></span>
            <span class="glyphicon glyphicon-menu-down" aria-hidden="true"></span>
          </span>
        </div>
      </div>
    </div>
    <div class="col-md-4 col-sm-6">
      <div id="cnranges" class="form-horizontal">
        <div class="form-group">
          <label for="cnrange-1" class="col-sm-2">Call Number Range</label>
          <div class="input-group col-sm-10">
            <input type="text" class="form-control" id="cnrange-1" pattern="([A-Z]{1,3}\s?(?:[1-9][0-9\.]{0,8})?)(?:\s{0,3}-\s{0,3}([A-Z]{0,3}\s?(?:[1-9][0-9\.]{0,8})?))?" />
            <span class="delete input-group-addon" role="button">
              <span class="glyphicon glyphicon-remove" aria-hidden="true"></span>
              <span class="sr-only">Remove this row</span>
            </span>
          </div>
        </div>
        <div class="col-offset-2 col-sm-2">
          <button type="button" class="add btn btn-default">
            <span class="glyphicon glyphicon-plus" aria-hidden="true"></span>
            <span class="sr-only">Add a row</span>
          </button>
        </div>
      </div>
    </div>
    <div class="col-md-4 col-sm-6">
      <button class="btn btn-primary" id="submit">Go</button>
    </div>
  </div>
</div>
<script>
$(document).ready(function() {
  var report = novanet.allreports['circ-by-callnumber'];

  var $sublibSelect = $('#sublibrary'),
      prohibited    = /^(.+NET|NSHA|NOVA|WWW)$/,
      $start        = $("#startdate"),
      $end          = $("#enddate"),
      $dateDisplay  = $("#period .date-display"),
      $cnranges     = $("#cnranges");

  //add options to $sublibSelect
  $.each(Object.keys(novanet.data.sublibraries).sort(), function(idx, code){
    var text = novanet.data.sublibraries[code],
        $opt = $("<option>").attr("value", code).html(text + "(" + code + ")");
    
    if (code.match(prohibited)){
      $opt.prop("disabled", true);
    }
    $sublibSelect.append($opt);
  });

  //make it nice:
  $sublibSelect.chosen({
    no_results_text: "No matching sublibrary",
    search_contains: true,
    label_with_value_only: true,
    width: '25em'
  });

  //set up daterangepicker
  var writeDatesCallback = function(s,e){
    $dateDisplay.html(s.format('MMMM D, YYYY') + ' - ' + e.format('MMMM D, YYYY'));
    $start.val(s.format('YYYY-MM-DD'));
    $end.val(e.format('YYYY-MM-DD'));
  }, sept1st = moment();
  while (sept1st.month() != 8){
    sept1st.subtract(1,'month');
  }
  sept1st.startOf('month');
  writeDatesCallback(sept1st,moment());
  
  $('#period').daterangepicker({
    startDate: moment($start.val()),
    endDate: moment($end.val()),
    minDate: moment().subtract(6, 'years'),
    maxDate: moment(),
    maxSpan: {'days': 365},
    showDropdowns: true,
    ranges: {
      'Last 30 Days': [moment().subtract(29,'days'), moment()],
      'Last Month': [moment().subtract(1,'month').startOf('month'), moment().subtract(1,'month').endOf('month')],
      'This Academic Year': [sept1st, moment()],
      'Last Academic Year': novanet.fn.prevYearStartingAt(8),
      'This Calendar Year': [moment().startOf('year'),moment()],
      'Last Calendar Year': novanet.fn.prevYearStartingAt(0)
    }
  }, writeDatesCallback);

  //set up the callnumber range input
  $cnranges.on("click", ".delete", function(evt){
    evt.preventDefault();
    if ($cnranges.find(".form-group").length() > 1){  
      $(this).parents(".form-group").remove();
    }
  }).on("click", ".add", function(evt){
    evt.preventDefault();
    var $last  = $cnranges.find(".form-group").last()
        $clone = $last.clone(),
        $input = $clone.find("input"),
        id     = $input.attr("id"),
        num    = parseInt(name.substr(name.indexOf('-')+1),10);
    $input.val("").attr("id", "cnrange-" + (++num));
    $clone.find("label").remove();
    $last.after($clone);
  });

  //submitting the form loads the results.
  $("#submit").on('click', function(evt){
    var sublibrary = $sublibSelect.val(),
        startdate = $start.val(),
        enddate  = $end.val(),
        cnranges = $cnranges.find("input").map(function(){ return $(this).val() || null; }).get();
    
    if (!startdate || !enddate || !sublibrary || sublibrary === [] || !cnranges || cnranges === []){
      //more fully validate start date
      return false;
    }

    var data = {
      "sublibrary[]": sublibrary,
      "start-date": startdate,
      "end-date": enddate,
      "range[]": cnranges
    };

    novanet.fn.loadResults(report, data);
    novanet.fn.pushState(report, data);
  });
});

</script>

