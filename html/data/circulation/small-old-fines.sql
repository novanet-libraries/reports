SELECT
  NAME,
  HOME_LIBRARY,
  AMOUNT,
  BARCODE,
  INST_ID
FROM WEBREPORT.PATRON_GLOBAL g
JOIN
(
  SELECT USER_ID, SUM(OWED_NOW)/100 AMOUNT
  FROM (
    SELECT
      SUBSTR(Z31_REC_KEY,1,12) USER_ID,
      CASE
        WHEN Z31_DATE_X < :CUTOFFDATE AND Z31_CREDIT_DEBIT = 'C' THEN Z31_SUM * -1
        WHEN Z31_DATE_X < :CUTOFFDATE AND Z31_CREDIT_DEBIT = 'D' THEN Z31_SUM *  1
        ELSE 0
      END OWED_THEN,
      CASE
        WHEN Z31_CREDIT_DEBIT = 'C' THEN Z31_SUM * -1
        WHEN Z31_CREDIT_DEBIT = 'D' THEN Z31_SUM *  1
        ELSE 0
      END OWED_NOW
      FROM NOV50.Z31
    WHERE Z31_STATUS = 'O'
  )
  GROUP BY USER_ID
  HAVING SUM(OWED_THEN) < 1000 AND SUM(OWED_THEN) > 0 AND (SUM(OWED_THEN) >= SUM(OWED_NOW))
) t
ON (g.USER_ID = t.USER_ID)
LEFT OUTER JOIN WEBREPORT.PATRON_IDS i ON (i.USER_ID = g.USER_ID)
WHERE HOME_LIBRARY IN ( :SUBLIBRARIES )
