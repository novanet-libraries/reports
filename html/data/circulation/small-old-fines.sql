SELECT
  Z303_NAME,
  Z303_HOME_LIBRARY,
  AMOUNT,
  BARCODE,
  INST_ID
FROM NOV50.Z303
JOIN
(
  SELECT USERID, SUM(OWED_NOW)/100 AMOUNT
  FROM (
    SELECT
      SUBSTR(Z31_REC_KEY,1,12) USERID,
      CASE
        WHEN Z31_DATE_X < :CUTOFFDATE AND Z31_CREDIT_DEBIT = 'C' THEN Z31_SUM * -1
        WHEN Z31_DATE_X < :CUTOFFDATE AND Z31_CREDIT_DEBIT = 'D' THEN Z31_SUM *  1
        ELSE 0
      END OWED_THEN,
      CASE
        WHEN Z31_CREDIT_DEBIT = 'C' THEN Z31_SUM * -1
        WHEN Z31_CREDIT_DEBIT = 'D' THEN Z31_SUM *  1
        ELSE 0
      END OWED_NOW             
      FROM NOV50.Z31
    WHERE Z31_STATUS = 'O'
  )
  GROUP BY USERID
  HAVING SUM(OWED_THEN) < 1000 AND SUM(OWED_THEN) > 0 AND (SUM(OWED_THEN) >= SUM(OWED_NOW))
) T
ON (Z303_REC_KEY = T.USERID)
LEFT OUTER JOIN NOV50.PATRON_IDS ON (PATRON_IDS.USER_ID = Z303_REC_KEY)
WHERE RTRIM(Z303_HOME_LIBRARY) IN ( :SUBLIBRARY )
