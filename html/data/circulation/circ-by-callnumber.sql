SELECT
  BARCODE,
  INST_ID,
  Z303_NAME,
  Z303_HOME_LIBRARY,
  Z305_BOR_STATUS,
  COUNT(CASE EVENT WHEN 'LOAN'      THEN 1 ELSE NULL END) AS LOANS,
  COUNT(CASE EVENT WHEN 'RENEWAL'   THEN 1 ELSE NULL END) AS RENEWALS,
  COUNT(CASE EVENT WHEN 'HOLD'      THEN 1 ELSE NULL END) AS HOLDS,
  COUNT(CASE EVENT WHEN 'PHOTOCOPY' THEN 1 ELSE NULL END) AS PHOTOCOPIES,
  COUNT(CASE EVENT WHEN 'BOOKING'   THEN 1 ELSE NULL END) AS BOOKINGS,
  COUNT(*) AS TOTAL
FROM (
    SELECT
      BARCODE,
      INST_ID,
      TRIM(Z303_NAME) Z303_NAME,
      RTRIM(Z303_HOME_LIBRARY) Z303_HOME_LIBRARY,
      Z305_BOR_STATUS,
      CASE
        WHEN Z35_EVENT_TYPE IN ('50')                   THEN 'LOAN'
        WHEN Z35_EVENT_TYPE IN ('62', '63')             THEN 'RENEWAL'
        WHEN Z35_EVENT_TYPE IN ('71', '72', '73', '74') THEN 'HOLD'
        WHEN Z35_EVENT_TYPE = '81'                      THEN 'PHOTOCOPY'
        WHEN Z35_EVENT_TYPE = '90'                      THEN 'BOOKING'
      END AS EVENT
     FROM NOV50.Z303
     JOIN NOV50.Z35  ON (Z303_REC_KEY = Z35_ID)
     JOIN NOV50.Z305 ON (Z303_REC_KEY || Z303_HOME_LIBRARY = Z305_REC_KEY)
     JOIN NOV50.PATRON_IDS ON (Z303_REC_KEY = USER_ID)
    WHERE RTRIM(Z303_HOME_LIBRARY) IN :SUBLIBRARY
      AND Z35_EVENT_DATE BETWEEN :STARTDATE AND :ENDDATE
      AND Z35_EVENT_TYPE IN ('50', '62', '63', '71', '72', '73', '74', '81', '90')  
  )
GROUP BY BARCODE, INST_ID, Z303_NAME, Z303_HOME_LIBRARY, Z305_BOR_STATUS
