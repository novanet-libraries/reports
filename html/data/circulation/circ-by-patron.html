<div class="form-inline">
  <div class="form-group">
    <label for="sublibrary">Sublibrary</label>
    <select id="sublibrary" class="form-control" data-placeholder="Sublibrary" multiple required>
      <option></option>
      <!-- javascript will fill in the rest of the options -->
    </select>
  </div>
  <div class="form-group">
    <label for="date-range">Date Range</label>
    <div id="date-range" class="form-control-static">
      <i class="glyphicon glyphicon-calendar"></i>
      <span></span>
      <i class="caret"></i>
      <input type="hidden" id="start-date"/>
      <input type="hidden" id="end-date"/>
    </div>
  </div>
  <!--
  <div class="form-group">
    <label for="start-date">From</label>
    <input type="date" id="start-date" class="form-control" placeholder="Start Date" required />
  </div>
  <div class="form-group">
    <label for="end-date">To</label>
    <input type="date" id="end-date" class="form-control" placeholder="End Date" required />
  </div>
-->
  <button type="submit" class="btn btn-primary" id="submit">Go</button>

</div>

<script>

$(document).ready(function() {
  var report = novanet.allreports["circ-by-patron"],
      $sublibSelect = $("#sublibrary"),
      prohibited = /^NOVA|WWW|.+NET|.+BK$/,
      $dateRange = $("#date-range"),
      $startDate = $("#start-date"),
      $endDate = $("#end-date"),
      prevSept1 = function(){
        var y = novanet.now.year(),
            d = (novanet.now.month() >= 8) ? y + "-09-01" : (y-1) + "-09-01";
        return moment(d);
      }(),
      setDateValues = function(start, end){
        $dateRange.find('span').html( start.format('MMM D, YYYY') + ' - ' + end.format('MMM D, YYYY') );
        $startDate.val(start.format('YYYY-MM-DD'));
        $endDate.val(end.format('YYYY-MM-DD'));
      };

  //add options for sublib select
  $.each(Object.keys(novanet.data.allSublibraries).sort(), function(idx, code){
    var $opt, text = novanet.data.allSublibraries[code];

    $opt = $("<option>").attr("value", code).html(text + " (" + code + ")");
    if (code.match(prohibited)){
      $opt.prop("disabled", true);
    }

    $sublibSelect.append($opt);
  });

  //make it nice:
  $sublibSelect.chosen({
    no_results_text: "No matching sublibrary",
    search_contains: true,
    label_with_value_only: true,
    width: "25em"
  });

  //setup datepicker widget
  $dateRange.daterangepicker({
    drops: "up",
    format: 'YYYY-MM-DD',
    minDate: moment('2006-09-01'),
    maxDate: novanet.now,
    showDropdowns: true,
    ranges: {
       'Yesterday': [moment().subtract(1, 'days'), moment().subtract(1, 'days')],
       'Last 7 Days': [moment().subtract(6, 'days'), novanet.now],
       'Last 30 Days': [moment().subtract(29, 'days'), novanet.now],
       'Last Month': [moment().subtract(1, 'month').startOf('month'), moment().subtract(1, 'month').endOf('month')],
       'Last Academic Year': novanet.fn.prevYearStartingAt(8),
       'This Academic Year': [prevSept1, novanet.now]
    }
  }, setDateValues);

  //set initial values
  setDateValues(prevSept1, novanet.now);

  $("#submit").on("click", function(evt){
    evt.preventDefault();
    var selections = $sublibSelect.val(),
        data = {
          "sublibrary[]" : selections,
          "start-date"   : $startDate.val(),
          "end-date"     : $endDate.val()
        };

    if (selections === null || selections === []){
      //alert that they must choose one or more?
      return false;
    }

    novanet.fn.loadResults(report, data);
    novanet.fn.pushState(report, data);
  });

});

</script>
