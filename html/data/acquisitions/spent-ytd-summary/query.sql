
/*  Faster version (requires MAT.VIEW) */
SELECT 
  BUDGET_NUMBER,
  Z76_NAME BUDGET,
  ALLOCATED,
  CASE
    WHEN Z76_MAX_OVER_SIGN = 'C' AND Z76_SW_ABSOLUTE_PERCENT = 'P' THEN ALLOCATED * -(Z76_MAX_OVER_EXPENDITURE/10000)
    WHEN Z76_MAX_OVER_SIGN = 'D' AND Z76_SW_ABSOLUTE_PERCENT = 'P' THEN ALLOCATED *  (Z76_MAX_OVER_EXPENDITURE/10000)
    WHEN Z76_MAX_OVER_SIGN = 'C' AND Z76_SW_ABSOLUTE_PERCENT = 'A' THEN Z76_MAX_OVER_EXPENDITURE / -100
    WHEN Z76_MAX_OVER_SIGN = 'D' AND Z76_SW_ABSOLUTE_PERCENT = 'A' THEN Z76_MAX_OVER_EXPENDITURE /  100
    ELSE NULL
  END AS MAX_OVER_SPEND,
  SPENT,
ROUND(SPENT/NULLIF(ALLOCATED,0),5) AS PERCENT_SPENT
FROM NOV50.Z76
JOIN WEBREPORT.Z601_SUMS_PER_BUDGET ON (RTRIM(Z76_BUDGET_NUMBER) = BUDGET_NUMBER)
WHERE RTRIM(Z76_BUDGET_NUMBER) IN ( :BUDGETS )



/*  slower version */
/*
SELECT
  Z76_BUDGET_NUMBER AS BUDGET_NUMBER,
  Z76_NAME AS BUDGET,
  ALLOCATED,
  MAX_OVER_SPEND,
  SPENT,
  ROUND(SPENT/NULLIF(ALLOCATED,0)*100,2) AS PERCENT_SPENT
 FROM(
  SELECT
    Z76_BUDGET_NUMBER,
    Z76_NAME,
    ALLOCATED, 
    CASE Z76_SW_ABSOLUTE_PERCENT
      WHEN 'P' THEN ALLOCATED*MAX_OVER_SPEND / 100
      ELSE MAX_OVER_SPEND
    END AS MAX_OVER_SPEND,
    SPENT
  FROM(
    SELECT
      Z76_BUDGET_NUMBER, 
      Z76_NAME,
      CASE Z76_MAX_OVER_SIGN
        WHEN 'C' THEN Z76_MAX_OVER_EXPENDITURE / -100
        WHEN 'D' THEN Z76_MAX_OVER_EXPENDITURE /  100
        ELSE NULL
      END AS MAX_OVER_SPEND,      
      Z76_SW_ABSOLUTE_PERCENT, 
      ALLOCATED, 
      SPENT
    FROM (
      SELECT 
        Z76_BUDGET_NUMBER,
        Z76_NAME,
        Z76_MAX_OVER_EXPENDITURE,
        Z76_MAX_OVER_SIGN,
        Z76_SW_ABSOLUTE_PERCENT,
        SUM(
          CASE 
            WHEN Z601_CREDIT_DEBIT = 'C' AND Z601_TYPE IN ('INV', 'ENC') THEN Z601_LOCAL_SUM / -100 
            WHEN Z601_CREDIT_DEBIT = 'D' AND Z601_TYPE IN ('INV', 'ENC') THEN Z601_LOCAL_SUM /  100
            ELSE NULL
          END
        ) AS SPENT,
        SUM(
          CASE  
            WHEN Z601_CREDIT_DEBIT = 'C' AND Z601_TYPE NOT IN ('INV', 'ENC') THEN Z601_LOCAL_SUM /  100
            WHEN Z601_CREDIT_DEBIT = 'D' AND Z601_TYPE NOT IN ('INV', 'ENC') THEN Z601_LOCAL_SUM / -100
            ELSE NULL 
          END
        ) AS ALLOCATED
      FROM NOV50.Z601 JOIN NOV50.Z76 ON (SUBSTR(Z601_REC_KEY, 1, 50) = Z76_BUDGET_NUMBER)
      WHERE Z76_BUDGET_NUMBER IN :BUDGETS
      GROUP BY Z76_BUDGET_NUMBER, Z76_NAME, Z76_MAX_OVER_EXPENDITURE, Z76_MAX_OVER_SIGN, Z76_SW_ABSOLUTE_PERCENT
    )
  )
)
*/
