SELECT
  RTRIM(Z76_BUDGET_NUMBER) BUDGET_NUMBER,
  Z76_NAME,
  CASE Z601_CREDIT_DEBIT
    WHEN 'C' THEN Z601_LOCAL_SUM / -100
    ELSE Z601_LOCAL_SUM / 100
  END LOCALSUM,
  RTRIM(Z68_ORDER_NUMBER) ORDER_NUMBER,
  Z68_ORDERING_UNIT,
  RTRIM(Z68_VENDOR_CODE) VENDOR_CODE,
  Z68_ORDER_TYPE,
  Z68_MATERIAL_TYPE,
  Z68_NO_UNITS UNITS_ORDERED,
  Z75_I_NO_UNITS UNITS_INVOICED,
  UNITS_ARRIVED,
  RTRIM(Z75_I_OBJECT_CODE) OBJECT_CODE,
  Z77_P_DATE,
  ADM_NUMBER,
  BIB_NUMBER,
  Z13_AUTHOR,
  Z13_TITLE,
  Z13_IMPRINT,
  Z13_ISBN_ISSN,
  Z13_CALL_NO
FROM NOV50.Z68
JOIN NOV50.Z75 ON (Z75_REC_KEY = Z68_REC_KEY)
JOIN NOV50.Z77 ON (Z77_REC_KEY = SUBSTR(Z75_REC_KEY_2, 1, 35))
JOIN (
  SELECT SUM(Z78_NO_UNITS_ARRIVED) UNITS_ARRIVED, SUBSTR(Z78_REC_KEY, 1, 14) INNER_REC_KEY
  FROM NOV50.Z78
  GROUP BY SUBSTR(Z78_REC_KEY, 1, 14)
) ON (INNER_REC_KEY = Z68_REC_KEY)
JOIN NOV50.Z601 ON (Z601_REC_KEY_2 = Z75_REC_KEY_2)
JOIN NOV50.Z76 ON SUBSTR(Z601_REC_KEY, 1, 50) = Z76_BUDGET_NUMBER
JOIN NOV50.ADM_BIB_LOOKUP ON SUBSTR(Z68_REC_KEY,1,9) = ADM_NUMBER
JOIN NOV01.Z13 ON BIB_NUMBER = Z13_REC_KEY
WHERE Z68_ORDERING_UNIT = :ORDERUNIT
AND Z76_BUDGET_NUMBER = :BUDGETNUMBER

